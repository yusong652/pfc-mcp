{
  "command": "measure create",
  "category": "measure",
  "search_keywords": ["create", "region", "porosity"],
  "description": "Create a measurement region. Measurement regions are disks in 2D and spheres in 3D. The measurement calculation is triggered whenever a clean command is invoked, or whenever a FISH intrinsic that queries a measured value is invoked. Measurement regions can calculate porosity, coordination number, stress, strain, and particle size distributions.",

  "syntax": "measure create <keyword> ...",

  "keywords": [
    {
      "name": "id",
      "syntax": "id <i>",
      "description": "Measurement ID. If not specified, the next available ID is assigned automatically.",
      "required": false,
      "parameters": [
        {
          "name": "i",
          "type": "integer",
          "required": true,
          "description": "Unique measurement region identifier"
        }
      ]
    },
    {
      "name": "position",
      "syntax": "position <v>",
      "description": "Position of the center of the measurement object. Defaults to the origin of the global axis system (0,0,0).",
      "required": false,
      "parameters": [
        {
          "name": "v",
          "type": "vector",
          "required": true,
          "description": "Vector specifying (x,y,z) coordinates of measurement center"
        }
      ]
    },
    {
      "name": "position-x",
      "syntax": "position-x <f>",
      "description": "X-coordinate of the center of the measurement object. Default is 0.0",
      "required": false,
      "parameters": [
        {
          "name": "f",
          "type": "float",
          "required": true,
          "description": "X-coordinate value"
        }
      ]
    },
    {
      "name": "position-y",
      "syntax": "position-y <f>",
      "description": "Y-coordinate of the center of the measurement object. Default is 0.0",
      "required": false,
      "parameters": [
        {
          "name": "f",
          "type": "float",
          "required": true,
          "description": "Y-coordinate value"
        }
      ]
    },
    {
      "name": "position-z",
      "syntax": "position-z <f>",
      "description": "Z-coordinate of the center of the measurement object (3D only). Default is 0.0",
      "required": false,
      "parameters": [
        {
          "name": "f",
          "type": "float",
          "required": true,
          "description": "Z-coordinate value"
        }
      ]
    },
    {
      "name": "radius",
      "syntax": "radius <f>",
      "description": "Radius of the measurement object (disk in 2D, sphere in 3D). Default is 1.0",
      "required": false,
      "parameters": [
        {
          "name": "f",
          "type": "float",
          "required": true,
          "description": "Radius value in model length units"
        }
      ]
    },
    {
      "name": "bins",
      "syntax": "bins <i> <fl> <fh>",
      "description": "Specify the number of bins and the lowest and highest bin edges for the size distribution calculation. All bodies (clumps and balls) within the measurement region are binned based on their volume-equivalent sphere diameters (3D) or area-equivalent circle diameters (2D). The cumulative volume percentage is calculated and can be exported with measure dump.",
      "required": false,
      "parameters": [
        {
          "name": "i",
          "type": "integer",
          "required": true,
          "description": "Number of bins for size distribution"
        },
        {
          "name": "fl",
          "type": "float",
          "required": true,
          "description": "Lowest bin edge (minimum diameter)"
        },
        {
          "name": "fh",
          "type": "float",
          "required": true,
          "description": "Highest bin edge (maximum diameter)"
        }
      ]
    },
    {
      "name": "tolerance",
      "syntax": "tolerance <f>",
      "description": "Specify the relative tolerance for accumulating the volume of bodies that intersect the measurement region boundary in the porosity calculation. Bodies completely within the region are fully counted. Bodies intersecting the boundary are processed in order of decreasing volume until the tolerance is met. Default is 0.01 (1%).",
      "required": false,
      "parameters": [
        {
          "name": "f",
          "type": "float",
          "required": true,
          "description": "Relative tolerance value (e.g., 0.01 for 1% tolerance)"
        }
      ]
    }
  ],

  "notes": [
    "Measurement regions are disks (2D) or spheres (3D)",
    "Measurements calculated when 'model clean' is called or when FISH intrinsic queries measurement",
    "Can measure: porosity, coordination number, stress, strain, size distribution",
    "Default position: origin (0, 0, 0)",
    "Default radius: 1.0",
    "Default tolerance: 0.01 (1% for porosity calculation)",
    "ID auto-assigned if not specified",
    "Use 'bins' keyword to enable particle size distribution calculation",
    "Tolerance controls accuracy vs. speed trade-off for porosity calculation",
    "For clumps, voxelization approach used to calculate intersection volumes",
    "Position can be specified as vector or individual x/y/z components"
  ],

  "examples": [
    {
      "command": "measure create radius 4.0 tolerance 0.001",
      "description": "Create measurement region with radius 4.0 at origin, high accuracy porosity (0.1% tolerance)",
      "use_case": "Measure porosity, coordination number, stress, and strain with high precision"
    },
    {
      "command": "measure create id 1 bins 100 0.0 0.5 radius 4.0",
      "description": "Create measurement with ID 1, 100 bins from 0.0 to 0.5 diameter, radius 4.0",
      "use_case": "Generate particle size distribution curve for analysis"
    },
    {
      "command": "measure create position (5.0, 3.0, 2.0) radius 2.5",
      "description": "Create measurement region centered at (5.0, 3.0, 2.0) with radius 2.5",
      "use_case": "Measure properties at specific location in model"
    },
    {
      "command": "measure create position-x 10.0 position-y 5.0 position-z 3.0 radius 3.0",
      "description": "Create measurement region using individual coordinate specifications",
      "use_case": "Alternative syntax for specifying measurement position"
    },
    {
      "command": "measure create id 5 radius 1.0 bins 50 0.1 1.0 tolerance 0.005",
      "description": "Comprehensive measurement setup with all major parameters",
      "use_case": "Complete measurement configuration for detailed analysis"
    },
    {
      "command": "measure create radius 5.0\nmodel clean\nmeasure list",
      "description": "Create measurement, trigger calculation, then list results",
      "use_case": "Basic measurement workflow"
    }
  ],

  "python_sdk_alternative": {
    "available": true,
    "methods": [
      {
        "module": "itasca.measure",
        "description": "PFC Python API provides measure module for creating and managing measurements",
        "note": "Command interface may be more convenient for simple setups"
      }
    ],
    "notes": [
      "Python SDK has measure-related methods in itasca.measure module",
      "Exact method signatures may vary - consult PFC Python documentation",
      "Command interface provides simpler syntax for basic measurement creation",
      "Python interface offers more programmatic control and querying"
    ],
    "command_vs_python": {
      "command": "measure create radius 4.0 tolerance 0.001",
      "python": "# Python SDK approach - consult PFC documentation for exact syntax\n# itasca.measure module provides measurement functionality"
    }
  },

  "related_commands": [
    "measure delete",
    "measure list",
    "measure modify",
    "measure dump",
    "measure history",
    "model clean"
  ],

  "common_use_cases": [
    {
      "use_case": "Measure porosity in specific region",
      "workflow": [
        "1. Create measurement: measure create radius 5.0 tolerance 0.001",
        "2. Trigger calculation: model clean",
        "3. Query results: measure list or FISH intrinsics",
        "4. Porosity calculated automatically within sphere"
      ],
      "notes": "High tolerance (0.001) gives accurate porosity for quality control"
    },
    {
      "use_case": "Generate particle size distribution",
      "workflow": [
        "1. Create with bins: measure create bins 100 0.0 2.0 radius 10.0",
        "2. Calculate: model clean",
        "3. Export data: measure dump command or history",
        "4. Plot cumulative volume percentage vs. diameter"
      ],
      "notes": "Bins parameter enables size distribution calculation"
    },
    {
      "use_case": "Multiple measurement regions",
      "workflow": [
        "1. Create region 1: measure create id 1 position (0,0,0) radius 3.0",
        "2. Create region 2: measure create id 2 position (10,0,0) radius 3.0",
        "3. Calculate: model clean",
        "4. Compare: measure list shows both regions",
        "5. Analyze spatial variation in properties"
      ],
      "notes": "Multiple regions allow spatial property mapping"
    },
    {
      "use_case": "Track measurement evolution during simulation",
      "workflow": [
        "1. Create measurement: measure create radius 5.0",
        "2. Setup history: measure history (if available)",
        "3. Run simulation: model cycle 10000",
        "4. Periodically call: model clean (triggers recalculation)",
        "5. Track porosity, stress, etc. evolution over time"
      ],
      "notes": "Use with history to monitor measurement changes"
    }
  ],

  "typical_workflow": [
    "1. Create measurement region: measure create <parameters>",
    "2. Trigger calculation: model clean",
    "3. Query results: measure list",
    "4. Export data (optional): measure dump",
    "5. Modify if needed: measure modify",
    "6. Delete when done: measure delete"
  ],

  "measured_quantities": {
    "description": "What can be measured within the measurement region",
    "porosity": {
      "description": "Void fraction within measurement region",
      "calculation": "1 - (solid volume / total volume)",
      "tolerance_effect": "Lower tolerance = more accurate but slower calculation"
    },
    "coordination_number": {
      "description": "Average number of contacts per body",
      "calculation": "Total contacts / number of bodies in region",
      "use": "Characterize packing density and contact network"
    },
    "stress": {
      "description": "Average stress tensor within region",
      "calculation": "Volume-averaged from contact forces",
      "use": "Analyze stress state in specific regions"
    },
    "strain": {
      "description": "Average strain tensor within region",
      "calculation": "Computed from body displacements",
      "use": "Track deformation in measurement region"
    },
    "size_distribution": {
      "description": "Particle size distribution",
      "calculation": "Binning bodies by volume-equivalent diameter",
      "requires": "bins keyword must be specified",
      "output": "Cumulative volume percentage vs. diameter"
    }
  },

  "measurement_triggering": {
    "description": "When are measurements calculated",
    "triggers": [
      {
        "trigger": "model clean command",
        "description": "Explicitly triggers measurement recalculation",
        "use_case": "Manual control over when measurements are updated"
      },
      {
        "trigger": "FISH intrinsic query",
        "description": "Querying a measured value automatically recalculates if needed",
        "use_case": "Measurements updated on-demand when accessed"
      }
    ],
    "note": "Measurements not calculated continuously - only when triggered",
    "recommendation": "Call model clean before querying measurements to ensure current values"
  },

  "tolerance_explanation": {
    "description": "How tolerance affects porosity calculation",
    "bodies_completely_inside": "Volume fully counted (no approximation)",
    "bodies_intersecting_boundary": {
      "challenge": "Complex intersection calculation, especially for clumps",
      "approach": "Process in order of decreasing volume",
      "stopping_criterion": "Stop when remaining volume < tolerance * total volume",
      "effect": "Porosity slightly overestimated for tolerance > 0"
    },
    "tolerance_values": {
      "0.001": "High accuracy (0.1% tolerance) - slower but precise",
      "0.01": "Default (1% tolerance) - good balance",
      "0.05": "Low accuracy (5% tolerance) - faster but less precise"
    },
    "recommendation": "Use default (0.01) unless high precision required or performance critical"
  },

  "bins_explanation": {
    "description": "Particle size distribution binning",
    "purpose": "Discretize size distribution into bins for analysis",
    "bin_count": "Number of bins (e.g., 100 for fine resolution)",
    "bin_edges": "fl (lowest) to fh (highest) diameter values",
    "body_classification": "Each body binned by volume-equivalent sphere diameter",
    "output": "Cumulative volume percentage for each bin",
    "export": "Use measure dump to export to table for plotting",
    "example": "bins 100 0.0 0.5 creates 100 bins from diameter 0.0 to 0.5"
  },

  "position_specification": {
    "description": "Two ways to specify measurement center position",
    "vector_form": {
      "syntax": "position (x, y, z)",
      "example": "position (5.0, 3.0, 2.0)",
      "use_when": "Convenient for copying from other sources"
    },
    "component_form": {
      "syntax": "position-x <x> position-y <y> position-z <z>",
      "example": "position-x 5.0 position-y 3.0 position-z 2.0",
      "use_when": "Changing only one coordinate component"
    },
    "default": "Origin (0, 0, 0) if not specified",
    "note": "Both forms produce identical results - choose based on convenience"
  },

  "clump_intersection_calculation": {
    "description": "How clump-measurement intersection volumes are calculated",
    "challenge": "Clumps are complex shapes - exact intersection is computationally expensive",
    "approach": "Voxelization with recursive refinement",
    "algorithm": [
      "1. Create bounding box around clump pebbles",
      "2. Recursively bisect into boxes 5 times",
      "3. Test each box: inside clump? inside measurement? intersecting?",
      "4. Sum volumes of boxes fully inside both",
      "5. Apply convergence correction for unresolved intersections"
    ],
    "accuracy": "Efficient and accurate without full geometric calculation",
    "note": "Low tolerance values don't necessarily improve accuracy beyond algorithm limits"
  },

  "warnings": [
    {
      "type": "measurement_not_automatic",
      "message": "Measurements are NOT calculated automatically during cycling - must call model clean",
      "severity": "MEDIUM",
      "mitigation": "Explicitly call model clean before querying measurements"
    },
    {
      "type": "tolerance_overestimation",
      "message": "For tolerance > 0, porosity will generally be slightly overestimated",
      "severity": "LOW",
      "mitigation": "Use lower tolerance (e.g., 0.001) for high-precision requirements"
    },
    {
      "type": "bins_required_for_size_distribution",
      "message": "Particle size distribution requires bins keyword - otherwise not calculated",
      "severity": "LOW",
      "mitigation": "Always specify bins if you need size distribution data"
    },
    {
      "type": "2d_vs_3d",
      "message": "Measurement regions are disks in 2D, spheres in 3D - position-z only valid in 3D",
      "severity": "LOW",
      "mitigation": "Omit position-z in 2D models"
    }
  ],

  "troubleshooting": [
    {
      "issue": "measure create succeeds but no measurements available",
      "solutions": [
        "Measurements not calculated yet - call model clean to trigger",
        "Use measure list to verify measurement was created",
        "Query measurements after model clean",
        "Check if measurement region contains any bodies"
      ]
    },
    {
      "issue": "Size distribution not calculated",
      "solutions": [
        "Verify bins keyword was specified in measure create",
        "Call model clean to trigger calculation",
        "Check if measurement region contains bodies",
        "Use measure dump to export size distribution data"
      ]
    },
    {
      "issue": "Measurement ID conflict",
      "solutions": [
        "Specified ID already exists - use different ID",
        "Delete existing measurement: measure delete id <i>",
        "Omit id keyword to auto-assign next available ID",
        "Use measure list to see existing IDs"
      ]
    },
    {
      "issue": "Porosity calculation slow",
      "solutions": [
        "Increase tolerance: tolerance 0.05 (faster but less accurate)",
        "Default tolerance 0.01 is usually good balance",
        "Very low tolerance (< 0.001) can be slow for complex clumps",
        "Consider if high precision is really needed"
      ]
    },
    {
      "issue": "Measurement region contains no bodies",
      "solutions": [
        "Check position - is measurement region in correct location?",
        "Increase radius to encompass more bodies",
        "Use measure list to verify position and radius",
        "Visualize measurement region in GUI if available"
      ]
    }
  ],

  "performance_considerations": {
    "creation_cost": "Very fast - just defines measurement parameters",
    "calculation_cost": "Varies with region size, body count, and tolerance",
    "tolerance_impact": {
      "high_tolerance": "Faster calculation, slightly less accurate porosity",
      "low_tolerance": "Slower calculation, more accurate porosity"
    },
    "clump_overhead": "Clumps more expensive than balls due to voxelization",
    "bins_overhead": "Size distribution adds minimal overhead",
    "recommendation": "Use default tolerance (0.01) unless specific requirements"
  },

  "id_management": {
    "description": "Managing measurement IDs",
    "auto_assignment": "If id keyword omitted, next available ID assigned",
    "manual_assignment": "Use id keyword to specify exact ID",
    "uniqueness": "Each measurement must have unique ID",
    "recommendation": "Let PFC auto-assign unless you need specific IDs for organization"
  },

  "when_to_use_measure": {
    "good_use_cases": [
      "Calculate porosity in specific regions",
      "Generate particle size distributions",
      "Track stress/strain in measurement regions",
      "Analyze coordination numbers",
      "Compare properties between different regions"
    ],
    "not_suitable_for": [
      "Global properties (use FISH functions instead)",
      "Single body properties (query body directly)",
      "Continuous monitoring (measurements only on clean/query)",
      "Non-spherical regions (only disks/spheres supported)"
    ]
  }
}
